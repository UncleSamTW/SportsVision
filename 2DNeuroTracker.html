<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>簡易 NeuroTracker</title>
  <style>
    body {
      margin: 0;
      background: black;
      overflow: hidden;
      position: relative;
      height: 100vh;
      width: 100vw;
      font-family: sans-serif;
    }
    .ball {
      position: absolute;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      background: white;
      cursor: pointer;
    }
    .center-dot {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      background: green;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
    }
    .info {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-size: 20px;
      z-index: 3;
    }
    #countdown {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: yellow;
      font-size: 80px;
      display: none;
      z-index: 4;
    }
    #settings {
      position: absolute;
      top: 10px;
      right: 10px;
      color: white;
      font-size: 18px;
      z-index: 3;
      background: rgba(0,0,0,0.5);
      padding: 8px;
      border-radius: 6px;
    }
    #settings input {
      width: 50px;
      margin-left: 5px;
    }
    #startBtn {
      margin-left: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="center-dot"></div>
  <div class="info">
    難度: <span id="difficulty">1</span>
  </div>
  <div id="settings">
    起始速度: <input type="number" id="startSpeed" value="2" min="1" step="0.5">
    <button id="startBtn">開始遊戲</button>
  </div>
  <div id="countdown"></div>
  <script>
    const numBalls = 8;
    let balls = [];
    let targets = [];
    let selected = [];
    let speed = 2;
    let difficulty = 1;
    let anim;

    const difficultyEl = document.getElementById("difficulty");
    const countdownEl = document.getElementById("countdown");
    const startSpeedEl = document.getElementById("startSpeed");
    const startBtn = document.getElementById("startBtn");

    function createBalls() {
      balls.forEach(b => b.remove());
      balls = [];
      for (let i = 0; i < numBalls; i++) {
        const ball = document.createElement("div");
        ball.classList.add("ball");
        ball.style.left = Math.random() * (window.innerWidth - 80) + "px";
        ball.style.top = Math.random() * (window.innerHeight - 80) + "px";
        ball.vx = (Math.random() - 0.5) * speed * 2;
        ball.vy = (Math.random() - 0.5) * speed * 2;
        document.body.appendChild(ball);
        balls.push(ball);

        ball.addEventListener("click", () => {
          if (selected.includes(ball)) return;
          if (!ball.clickable) return;
          selected.push(ball);

          if (targets.includes(ball)) {
            ball.style.background = "green";
          } else {
            ball.style.background = "red";
          }

          if (selected.length === targets.length) {
            checkResult();
          }
        });
      }
    }

    function moveBalls() {
      balls.forEach(ball => {
        let x = parseFloat(ball.style.left);
        let y = parseFloat(ball.style.top);
        x += ball.vx;
        y += ball.vy;

        if (x <= 0 || x >= window.innerWidth - 80) ball.vx *= -1;
        if (y <= 0 || y >= window.innerHeight - 80) ball.vy *= -1;

        ball.style.left = x + "px";
        ball.style.top = y + "px";
      });
      anim = requestAnimationFrame(moveBalls);
    }

    function startRound() {
      selected = [];
      targets = [];
      balls.forEach(b => {
        b.style.background = "white";
        b.clickable = false;
      });

      while (targets.length < 3) {
        const choice = balls[Math.floor(Math.random() * balls.length)];
        if (!targets.includes(choice)) targets.push(choice);
      }
      targets.forEach(ball => ball.style.background = "red");

      setTimeout(() => {
        targets.forEach(ball => ball.style.background = "white");
        moveBalls();
        setTimeout(() => {
          cancelAnimationFrame(anim);
          balls.forEach(b => b.clickable = true);
        }, 8000);
      }, 2000);
    }

    function checkResult() {
      balls.forEach(b => b.clickable = false);
      let correct = selected.every(b => targets.includes(b)) && selected.length === targets.length;

      if (correct) {
        speed += 1;
      } else {
        speed = Math.max(1, speed - 0.5);
      }
      difficulty = Math.round(speed);
      difficultyEl.textContent = difficulty;

      setTimeout(() => nextRound(), 1000);
    }

    function nextRound() {
      let count = 3;
      countdownEl.style.display = "block";
      countdownEl.textContent = count;
      let interval = setInterval(() => {
        count--;
        if (count > 0) {
          countdownEl.textContent = count;
        } else {
          clearInterval(interval);
          countdownEl.style.display = "none";
          createBalls();
          startRound();
        }
      }, 1000);
    }

    startBtn.addEventListener("click", () => {
      speed = parseFloat(startSpeedEl.value) || 2;
      difficulty = Math.round(speed);
      difficultyEl.textContent = difficulty;
      createBalls();
      nextRound();
    });
  </script>
</body>
</html>
