<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>倒數語音訓練</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background-color: white;
      color: black;
      font-family: sans-serif;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    #countdown {
      font-size: 160px;
      font-weight: bold;
    }
    #color {
      font-size: 80px;
      font-weight: bold;
      margin-top: 40px;
    }
    #startBtn {
      font-size: 24px;
      padding: 16px 32px;
      background-color: black;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    h1 {
      font-size: 32px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>倒數語音訓練</h1>
  <button id="startBtn">開始訓練</button>
  <div id="countdown"></div>
  <div id="color"></div>

  <script>
    const colors = ["黑色", "紅色", "黃色"];
    let autoRunning = false;

    function speak(text, rate = 1.2, callback) {
      speechSynthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "zh-TW";
      utterance.rate = rate;

      let called = false;
      utterance.onend = () => {
        if (!called) {
          called = true;
          if (callback) callback();
        }
      };

      speechSynthesis.speak(utterance);

      setTimeout(() => {
        if (!called) {
          called = true;
          if (callback) callback();
        }
      }, 3000);
    }

    function startCountdown() {
      if (autoRunning) return;
      autoRunning = true;

      document.getElementById("startBtn").style.display = "none";

      const countdown = document.getElementById("countdown");
      const colorText = document.getElementById("color");

      colorText.textContent = "";
      let counter = 9;
      countdown.textContent = counter;

      function countdownStep() {
        if (counter > 3) {
          countdown.textContent = counter;
          counter--;
          setTimeout(countdownStep, 1000);
        } else if (counter >= 1) {
          countdown.textContent = counter;
          speak(String(counter), () => {
            counter--;
            countdownStep();
          });
        } else {
          countdown.textContent = "";
          speakRandomColor(() => {
            autoRunning = false;
            startCountdown();
          });
        }
      }

      countdownStep();
    }

    function speakRandomColor(callback) {
      const color = colors[Math.floor(Math.random() * colors.length)];
      const colorText = document.getElementById("color");
      colorText.textContent = color;

      speak(color, 1.4, callback);
    }

    document.getElementById("startBtn").addEventListener("click", () => {
      startCountdown();
    });
  </script>
</body>
</html>
